---
layout: post
title: >
    CVE-2019-17421 Privilege Escalation Vulnerability In Zoho's OpManager & Firewall Analyzer
hide_title: false
tags: ['vulnerabilities', 'CVE', 'vulnerability writeup', 'Privilege Escalation']
excerpt: Vulnerability writeup for CVE-2019-17421 that allows privilege escalation to root through OpManager products
author: guy
redirect_from: /2019/11/cve-2019-17421-privilege-escalation.html
---

## Product & Vendor Context

{% include image.html url="/assets/img/posts\manageengine_logo-zoho.png" caption="" alt="" %}
ManageEngine which is a division in Zoho Corp. creates IT management software and tools. The company is a major player in IT management with over 90 tools, and 3 million users served in over 190 countries.

{% include image.html url="/assets/img/posts\firwall_opmanager_logos.png" caption="" alt="" %}
Two of ManageEngine&#x27;s popular products are it&#x27;s network firewall analyzer and network monitoring software respectively named ManageEngine Firewall Analyzer and ManageEngine OpManager. Vulnerability CVE\-2019\-17421 affects both \(and possibly more\) of these products.

## Vulnerability
After I set these programs as my research targets, I installed their free trial version, and began mapping out the attack surface. The first thing I noticed is that the program runs as root. This is great for our purposes as this means any local vulnerability will lead to LPE \(Local Privilege Escalation\). To achieve my goal of finding a security bug, I am no longer limited to only the remotely accessible attack surface.

Next, I found the program defaultly installs its files to `/opt/ManageEngine/OpManager/`. I checked the file permissions on files in that specific folder and found they are appropriately set: only root can modify them, but anyone can run them.

{% include image.html url="/assets/img/posts\Screenshot_2019-11-16_19-36-09.png" caption="File permissions appropriately set - everyone can execute but only root can modify" alt="" %}
I could have continued on to the next attack surface, however I didn't want to leave any stone unturned. Maybe there was a file hiding away in a folder or even two levels of folders that is writable by a non\-root user. I ran a simple recursive query to find all the files writable from my current \(non root\) user.

{% include image.html url="/assets/img/posts\Screenshot_2019-11-16_19-45-56.png" caption="Finding an inadequately protected file" alt="" %}

Wow, we found files that are writable by non\-root users\! After examining `/opt/ManageEngine/OpManager/Nipper/nipper` I realized that not only is the file writable by any user, it is also an executable file! This is a severe security bug since this means when the OpManger/Firewall Analyzer runs as root and executes nipper from this file, the file will also run as root \- if we insert malicious code into the file, we now have our malicious code running as root\!

{% include image.html url="/assets/img/posts\Screenshot_2019-11-16_20-04-40.png" caption="nipper is a world writable executable file" alt="" %}
## Exploit
The exploit is very straightforward \- we simply write our malicious payload to `/opt/ManageEngine/OpManager/Nipper/nipper` and wait for nipper to be executed. This happens when nipper is used in OpManager's or Firewall Analyzer's "network audit" functionality which can be triggered manually or on a preset schedule.
## Timeline
Sept. 8 \- I disclose bug to Zoho
Sept. 9 \- Zoho confirms bug disclosure received
Sept. 25 \- I ask for an update
Sept. 25 \- Zoho updates they have confirmed bug and are working on a fix
Oct. 10 \- I update Zoho's bug ticket with CVE\-2019\-17421
Oct. 31 \- Zoho updates they have published a fix in the latest release, documented it in the [readme](https://www.manageengine.com/products/firewall/readme.html) \(build 124099\), and award me 20 BugBounty points
